
<head>
	<title>Listly-Results</title>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Shadows+Into+Light' rel='stylesheet' type='text/css'>
    <link href='/styles/style.css' rel='stylesheet' type='text/css'>
    <link href='style.css' rel='stylesheet' type='text/css'>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
	<script>
		var directionsDisplay;
		var directionsService = new google.maps.DirectionsService();
		var map;
		var startLat;
		var startLng;
		var businesses;
		var markers;
				
		function initialize() {
	  		
			directionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers: true});
	  	  	startLat = <%-lat%>;
			startLng = <%-lng%>;
			
			businesses = <%-taskList%>;
			var startLoc = new google.maps.LatLng(startLat, startLng);
	  	  	var mapOptions = {
	    		zoom: 10,
	    		center: startLoc
	  	  	}
	  	 	map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
	  	  	directionsDisplay.setMap(map);
			directionsDisplay.setPanel(document.getElementById("directions_panel"));
			
			
  		    var marker = new google.maps.Marker({
  		    	position: startLoc, 
  		    	map: map, 
  		    	title:"Starting Location",
  				icon:"http://www.googlemapsmarkers.com/v1/A/FF0000/"
		
  		    });
			
			calcRoute();
			
  		    
								
		}
		
		function calcRoute() {
		  		  
		  var start = startLat + ',' + startLng;
		  var end = startLat + ',' + startLng;
		  var waypts = [];
		  markers = [];
		  		  		  
		  for (var i = 0; i < businesses.length; i++) {
		    waypts.push({
				location: businesses[i].address,
				stopover:true});
			
					
			markers.push({
				lat: businesses[i].lat,
				lng: businesses[i].lng,
				title: businesses[i].name 
				
			});
				 
								
		  }
		   
		  var request = {
		        origin: start,
		        destination: end,
		        waypoints: waypts,
		        optimizeWaypoints: true,
		        travelMode: google.maps.TravelMode.DRIVING
		  };
		  
		  directionsService.route(request, function(response, status) {
		      if (status == google.maps.DirectionsStatus.OK) {
		        directionsDisplay.setDirections(response);
				
				var route = response.routes[0];
				var order = route.waypoint_order;
				
				for (var i = 0; i < order.length; i++) {
					var index = order.indexOf(i);
					//console.log(index);
  				  	marker_lat = markers[index].lat;
  				  	marker_lng = markers[index].lng;
				  
  					var letter = String.fromCharCode("B".charCodeAt(0) + i);
					var loc = new google.maps.LatLng(marker_lat, marker_lng);
  	  				var marker = new google.maps.Marker({
  	  					position: loc, 
  	  					map: map, 
  						title: markers[index].title,
						icon:"http://www.googlemapsmarkers.com/v1/"+letter+"/009900/"
					
					});	
							
		      	}
			}
		  });
		   
		}
									
		google.maps.event.addDomListener(window, 'load', initialize);
		
	</script>
</head>
<body>

	<button id='logout'>Log Out</button>
	<div>
	    <div id="results-wrapper">
	        <h1>Here's where you should go!</h1>
	        <h3>The list of businesses that will allow you to complete all of your tasks:</h3>
	        <ul>
	        <% JSON.parse(taskList).forEach(function(bus) { %>
	            <li><h3>Go to <span class="bus"><%=bus.name%></span> at <span class='bus'><%=bus.address%></span> to complete:</h3></li>
	            <ul><% bus.tasks.forEach(function(task) { %>
	                <li><%=task%></li>
	            <% }); %></ul>
	        <%  }); %>
	        </ul>
	        <% if(JSON.parse(unsatisfiedToDos).length > 0) { %>
	            <h3>The items we couldn't find any businesses to satisfy:</h3>
	            <ul>
	            <% JSON.parse(unsatisfiedToDos).forEach(function(t) { %>
	                <li><%=t%></li>
	            <% }); %></ul>
	        <% } %>
	        <h1>Here's a map of your route!</h1></br>
	        <div id="map-canvas" style="width:100%;height:100%;"></div>	
	   	</div>
	    <div id="directions-wrapper">
	   		<h1>Here's how to get there!</h1>
	   		<h3>The best order for completing all of your tasks, and directions to route you:</h3>
       		<div id="directions_panel"></div>
        </div>
    </div>
	
	
</body>
<script>
	$('#logout').click(function() {
		$.post("/logout", function(res) {
	 		window.location.replace("/login");
	 	});
	});
</script>
